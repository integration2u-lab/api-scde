// Prisma schema for SCDE energy imports

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ImportBatch {
  id                  String   @id @default(cuid())
  batchKey            String   @unique
  idempotencyKey      String   @unique
  fileName            String
  mimeType            String
  origin              String
  overwriteStrategy   String   @default("upsert")
  energyInsertedCount Int      @default(0)
  energyUpdatedCount  Int      @default(0)
  energySkippedCount  Int      @default(0)
  scdeInsertedCount   Int      @default(0)
  scdeUpdatedCount    Int      @default(0)
  scdeSkippedCount    Int      @default(0)
  errorCount          Int      @default(0)
  errors              Json?
  createdAt           DateTime @default(now())
  completedAt         DateTime?

  energyBalances EnergyBalance[]
  scdeRecords    Scde[]
}

model EnergyBalance {
  id            String   @id @default(cuid())
  clients       String
  price         Decimal? @db.Decimal(18, 4)
  referenceDate DateTime? @map("reference_date")
  adjusted      Decimal? @db.Decimal(18, 4)
  supplier      String?
  meter         String?
  consumption   Decimal? @db.Decimal(18, 6)
  measurement   String?
  proinfa       Decimal? @db.Decimal(18, 4)
  contract      Decimal? @db.Decimal(18, 4)
  minimum       Decimal? @db.Decimal(18, 4)
  maximum       Decimal? @db.Decimal(18, 4)
  toBill        Decimal? @map("to_bill") @db.Decimal(18, 4)
  cp            String?
  charges       Json?
  importBatchId String
  origin        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  importBatch ImportBatch @relation(fields: [importBatchId], references: [batchKey], onDelete: Cascade)

  @@index([clients])
  @@index([referenceDate])
  @@unique([clients, referenceDate], map: "energy_balance_clients_reference_date_unique")
}

model Scde {
  id             String   @id @default(cuid())
  agent          String
  groupPoint     String?  @map("group_point")
  referenceMonth String   @map("reference_month")
  activeCKwh     Decimal? @map("active_c_kwh") @db.Decimal(18, 6)
  quality        String?
  source         String?
  importBatchId  String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  importBatch ImportBatch @relation(fields: [importBatchId], references: [batchKey], onDelete: Cascade)

  @@map("scde")
  @@index([referenceMonth])
  @@unique([agent, groupPoint, referenceMonth], map: "scde_agent_group_reference_unique")
}
